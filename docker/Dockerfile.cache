# -------- stage 0: build the cache inside a full tool image -------------
FROM ghcr.io/julius-muller/vcfstash:latest as builder
# ^ this is the regular image you already publish for the CLI

ARG CACHE_NAME=vep_gnomad
ARG AF=0.01
ARG TOOL_VERSION=113
ARG GENOME=GRCh38
ARG THREADS=8

# directory where the finished cache will live
ENV CACHE_DIR=/opt/vcfstash-cache

RUN mkdir -p ${CACHE_DIR}

# ===== create blueprint =====
#   The script below is intentionally simple; if you already have an
#   internal Nextflow pipeline for this, just replace this block with
#   "COPY --from=<pipeline-image> /cache ${CACHE_DIR}"
COPY docker/build-cache.sh /tmp/build-cache.sh
RUN bash /tmp/build-cache.sh \
      --gnomad-af ${AF} \
      --cache-dir ${CACHE_DIR} \
      --threads ${THREADS} \
      --tool-version ${TOOL_VERSION} \
      --cache-name ${CACHE_NAME} \
      --genome ${GENOME}

# -------- stage 1: shrink to a <500 MB runtime image --------------------
FROM mambaorg/micromamba:1.5.7 as runtime
LABEL maintainer="VCFstash Team <julius.mueller@dkfz-heidelberg.de>"
LABEL org.opencontainers.image.source="https://github.com/julius-muller/vcfstash"

ARG VCFSTASH_VERSION=latest

# Install only the runtime deps (python + bcftools + tabix)
RUN micromamba install -y -n base -c conda-forge \
        python=3.11 bcftools=1.20 htslib tabix && \
    micromamba clean --all --yes

# Copy CLI and cache
COPY --from=builder /usr/local/bin/vcfstash /usr/local/bin/
COPY --from=builder /opt/vcfstash-cache /cache

# Non-root user (uid 1000)
RUN useradd -m vcfstash && \
    chown -R vcfstash /cache
USER vcfstash
WORKDIR /work

ENV PATH=/usr/local/bin:$PATH
ENTRYPOINT ["vcfstash"]