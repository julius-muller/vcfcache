name: Precompute gnomAD BCF files

on:
  workflow_dispatch:
    inputs:
      af:
        description: "Allele-frequency threshold (e.g. 0.10)"
        required: true
        default: "0.10"
        type: choice
        options:
          - "0.10"
          - "0.05"
          - "0.01"
      chromosomes:
        description: "Chromosomes (space-separated or 'all')"
        required: true
        default: "all"
      gnomad_version:
        description: "gnomAD version"
        required: true
        default: "4.1"

  # Pre-compute weekly to keep BCF files fresh
  schedule:
    - cron: '0 3 * * 0'  # Sunday 3 AM UTC

jobs:
  precompute:
    name: Precompute gnomAD BCF with Hail
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set default values for scheduled runs
        id: defaults
        run: |
          AF="${{ github.event.inputs.af }}"
          CHR="${{ github.event.inputs.chromosomes }}"
          GNOMAD_VERSION="${{ github.event.inputs.gnomad_version }}"

          echo "af=${AF:-0.10}" >> $GITHUB_OUTPUT
          echo "chromosomes=${CHR:-all}" >> $GITHUB_OUTPUT
          echo "gnomad_version=${GNOMAD_VERSION:-4.1}" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Install Hail
        run: |
          pip install hail

      - name: Make export script executable
        run: chmod +x scripts/export_gnomad_hail.py

      - name: Export gnomAD data with Hail
        id: export
        run: |
          AF="${{ steps.defaults.outputs.af }}"
          CHR="${{ steps.defaults.outputs.chromosomes }}"
          GNOMAD_VERSION="${{ steps.defaults.outputs.gnomad_version }}"

          # Construct output filename
          CHR_SUFFIX=$(echo "$CHR" | tr ' ' '_')
          if [ "$CHR" = "all" ]; then
            BCF_NAME="gnomad_v${GNOMAD_VERSION}_GRCh38_af${AF}.bcf"
          else
            BCF_NAME="gnomad_v${GNOMAD_VERSION}_GRCh38_${CHR_SUFFIX}_af${AF}.bcf"
          fi

          echo "bcf-name=${BCF_NAME}" >> $GITHUB_OUTPUT

          # Build chromosome arguments
          if [ "$CHR" != "all" ]; then
            CHR_ARGS="--chr ${CHR}"
          else
            CHR_ARGS=""
          fi

          # Run the export script
          python scripts/export_gnomad_hail.py \
            --output "${BCF_NAME}" \
            --af "${AF}" \
            --genome GRCh38 \
            --gnomad-version "${GNOMAD_VERSION}" \
            ${CHR_ARGS}

      - name: Compress and verify BCF
        run: |
          BCF_NAME="${{ steps.export.outputs.bcf-name }}"

          # Verify the BCF file
          bcftools view -h "${BCF_NAME}" | head -20

          # Get file size
          ls -lh "${BCF_NAME}"

          # Count variants
          VARIANT_COUNT=$(bcftools view -H "${BCF_NAME}" | wc -l)
          echo "Total variants: ${VARIANT_COUNT}"

      - name: Create release tag
        id: tag
        run: |
          AF="${{ steps.defaults.outputs.af }}"
          CHR="${{ steps.defaults.outputs.chromosomes }}"
          GNOMAD_VERSION="${{ steps.defaults.outputs.gnomad_version }}"

          CHR_TAG=$(echo "$CHR" | tr ' ' '-')
          if [ "$CHR" = "all" ]; then
            TAG="gnomad-bcf-v${GNOMAD_VERSION}-af${AF}-genome"
          else
            TAG="gnomad-bcf-v${GNOMAD_VERSION}-af${AF}-${CHR_TAG}"
          fi

          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "gnomAD BCF: AF=${{ steps.defaults.outputs.af }}, Chr=${{ steps.defaults.outputs.chromosomes }}"
          body: |
            Pre-computed gnomAD v${{ steps.defaults.outputs.gnomad_version }} BCF file

            **Configuration:**
            - Allele Frequency: >= ${{ steps.defaults.outputs.af }}
            - Chromosomes: ${{ steps.defaults.outputs.chromosomes }}
            - Genome Build: GRCh38
            - gnomAD Version: ${{ steps.defaults.outputs.gnomad_version }}

            **Usage:**
            ```bash
            # Download
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/${{ steps.export.outputs.bcf-name }}
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/${{ steps.export.outputs.bcf-name }}.csi

            # Use with VCFstash
            vcfstash stash-init --vcf ${{ steps.export.outputs.bcf-name }} --output cache -y params.yaml
            ```
          files: |
            ${{ steps.export.outputs.bcf-name }}
            ${{ steps.export.outputs.bcf-name }}.csi
          draft: false
          prerelease: false
